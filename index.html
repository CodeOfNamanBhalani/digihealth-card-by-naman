<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiHealth Card</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #a6acaf 0%, #f9e79f 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .language-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(9, 2, 45, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 15px 8px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 2px solid #f1c40f;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #f1c40f;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #f1c40f;
            box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #2c3e50;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(241, 196, 15, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(241, 196, 15, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin: 5px;
        }

        .btn-backup {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            margin-bottom: 10px;
        }

        .btn-backup:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
        }

        .record-item, .medication-item, .reminder-item, .missed-dose-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f1c40f;
            position: relative;
        }

        .missed-dose-item {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .record-item h4, .medication-item h4, .reminder-item h4, .missed-dose-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .record-item p, .medication-item p, .reminder-item p, .missed-dose-item p {
            margin: 3px 0;
            font-size: 14px;
            color: #666;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        .emergency-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
        }

        .emergency-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .qr-code {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin-top: 15px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #2c3e50;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            font-weight: 600;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .notification.reminder {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .notification.medication {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .reminder-badge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
        }

        .medication-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .next-dose {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            color: #2980b9;
            margin-top: 5px;
        }

        .overdue {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #c0392b;
        }

        .stats-card {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .backup-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }

        #importFile {
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .nav-tab {
                font-size: 10px;
                padding: 12px 5px;
            }

            .medication-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <select class="language-selector" id="languageSelector">
                <option value="en">English</option>
                <option value="hi">हिंदी</option>
                <option value="gu">ગુજરાતી</option>
                <option value="te">తెలుগు</option>
            </select>
            <h1 id="appTitle">DigiHealth Card</h1>
            <p id="appSubtitle">Your Personal Medical Records</p>
            <div>
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Offline Mode</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('profile')" id="profileTab">Profile</button>
            <button class="nav-tab" onclick="showTab('records')" id="recordsTab">Records</button>
            <button class="nav-tab" onclick="showTab('medications')" id="medicationsTab">
                Medications
                <span class="reminder-badge" id="medicationBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="showTab('reminders')" id="remindersTab">
                Reminders
                <span class="reminder-badge" id="reminderBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="showTab('missed-doses')" id="missedDosesTab">
                Missed Doses
                <span class="reminder-badge" id="missedDosesBadge" style="display: none;">0</span>
            </button>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content active">
            <div class="card">
                <h3 id="profileTitle">Personal Information</h3>
                <div class="form-group">
                    <label id="nameLabel">Full Name</label>
                    <input type="text" id="patientName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label id="ageLabel">Age</label>
                    <input type="number" id="patientAge" placeholder="Enter your age">
                </div>
                <div class="form-group">
                    <label id="bloodGroupLabel">Blood Group</label>
                    <select id="bloodGroup">
                        <option value="">Select Blood Group</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="phoneLabel">Phone Number</label>
                    <input type="tel" id="phoneNumber" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label id="emergencyContactLabel">Emergency Contact</label>
                    <input type="tel" id="emergencyContact" placeholder="Emergency contact number">
                </div>
                <div class="form-group">
                    <label id="allergiesLabel">Known Allergies</label>
                    <textarea id="allergies" placeholder="List any known allergies" rows="3"></textarea>
                </div>
                <button class="btn" onclick="saveProfile()" id="saveProfileBtn">Save Profile</button>
            </div>

            <div class="card emergency-card">
                <h3 id="emergencyTitle">Emergency Information</h3>
                <div class="emergency-info" id="emergencyInfo">
                    <strong id="emergencyInfoText">Complete your profile to display emergency information</strong>
                </div>
            </div>

            <div class="qr-code">
                <h4 id="qrTitle">Share Medical Info</h4>
                <div id="qrCode">📱 QR Code will appear here</div>
                <button class="btn" onclick="generateQR()" id="generateQRBtn">Generate QR Code</button>
            </div>

            <!-- Data Backup & Restore Section -->
            <div class="card">
                <h3>Data Backup & Restore</h3>
                <button class="btn btn-backup" onclick="exportData()">📤 Export Data</button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                <button class="btn btn-backup" onclick="document.getElementById('importFile').click()">📥 Import Data</button>
                <div class="backup-info">
                    <p><strong>💡 Backup Information:</strong></p>
                    <p>• Export your data for backup or transfer to another device</p>
                    <p>• Import previously saved data to restore your records</p>
                    <p>• Keep your backup file safe and secure</p>
                    <p>• Importing will overwrite all existing data</p>
                </div>
            </div>
        </div>

        <!-- Medical Records Tab -->
        <div id="records" class="tab-content">
            <div class="card">
                <h3 id="addRecordTitle">Add Medical Record</h3>
                <div class="form-group">
                    <label id="recordDateLabel">Date</label>
                    <input type="date" id="recordDate">
                </div>
                <div class="form-group">
                    <label id="recordTypeLabel">Type</label>
                    <select id="recordType">
                        <option value="checkup">Regular Checkup</option>
                        <option value="diagnosis">Diagnosis</option>
                        <option value="treatment">Treatment</option>
                        <option value="lab">Lab Results</option>
                        <option value="vaccination">Vaccination</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="doctorNameLabel">Doctor/Hospital</label>
                    <input type="text" id="doctorName" placeholder="Doctor or hospital name">
                </div>
                <div class="form-group">
                    <label id="recordNotesLabel">Notes/Diagnosis</label>
                    <textarea id="recordNotes" placeholder="Detailed notes about the visit" rows="4"></textarea>
                </div>
                <button class="btn" onclick="addRecord()" id="addRecordBtn">Add Record</button>
            </div>

            <div id="recordsList">
                <h3 id="recordsListTitle">Medical History</h3>
                <div id="recordsContainer"></div>
            </div>
        </div>

        <!-- Medications Tab -->
        <div id="medications" class="tab-content">
            <div class="card">
                <h3 id="addMedicationTitle">Add Medication</h3>
                <div class="form-group">
                    <label id="medicationNameLabel">Medication Name</label>
                    <input type="text" id="medicationName" placeholder="Medicine name">
                </div>
                <div class="form-group">
                    <label id="dosageLabel">Dosage</label>
                    <input type="text" id="dosage" placeholder="e.g., 1 tablet, 5ml">
                </div>
                <div class="form-group">
                    <label id="frequencyLabel">Frequency</label>
                    <select id="frequency" onchange="toggleCustomFrequency()">
                        <option value="daily">Daily</option>
                        <option value="twice-daily">Twice Daily</option>
                        <option value="thrice-daily">Thrice Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="custom">Custom Reminder</option>
                    </select>
                </div>
                <div class="form-group" id="customFrequencyGroup" style="display: none;">
                    <label>Custom Frequency (Days)</label>
                    <select id="customFrequencyDays">
                        <option value="2">Every 2 Days</option>
                        <option value="3">Every 3 Days</option>
                        <option value="5">Every 5 Days</option>
                        <option value="7">Every 7 Days</option>
                        <option value="10">Every 10 Days</option>
                        <option value="15">Every 15 Days</option>
                        <option value="30">Every 30 Days</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="timingLabel">Timing</label>
                    <input type="time" id="timing">
                </div>
                <div class="form-group">
                    <label id="startDateLabel">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label id="endDateLabel">End Date (Optional)</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn" onclick="addMedication()" id="addMedicationBtn">Add Medication</button>
            </div>

            <div id="medicationsList">
                <h3 id="medicationsListTitle">Current Medications</h3>
                <div id="medicationsContainer"></div>
            </div>
        </div>

        <!-- Reminders Tab -->
        <div id="reminders" class="tab-content">
            <div class="card">
                <h3 id="addReminderTitle">Add Reminder</h3>
                <div class="form-group">
                    <label id="reminderTypeLabel">Type</label>
                    <select id="reminderType">
                        <option value="appointment">Doctor Appointment</option>
                        <option value="followup">Follow-up Visit</option>
                        <option value="test">Medical Test</option>
                        <option value="vaccination">Vaccination</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="reminderTitleLabel">Title</label>
                    <input type="text" id="reminderTitle" placeholder="Reminder title">
                </div>
                <div class="form-group">
                    <label id="reminderDateLabel">Date & Time</label>
                    <input type="datetime-local" id="reminderDateTime">
                </div>
                <div class="form-group">
                    <label id="reminderNotesLabel">Notes</label>
                    <textarea id="reminderNotes" placeholder="Additional notes" rows="3"></textarea>
                </div>
                <button class="btn" onclick="addReminder()" id="addReminderBtn">Add Reminder</button>
            </div>

            <div id="remindersList">
                <h3 id="remindersListTitle">Upcoming Reminders</h3>
                <div id="remindersContainer"></div>
            </div>
        </div>

        <!-- Missed Doses Tab -->
        <div id="missed-doses" class="tab-content">
            <div class="stats-card">
                <div class="stat-item">
                    <div class="stat-value" id="totalMissedCount">0</div>
                    <div class="stat-label">Total Missed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="thisWeekMissedCount">0</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="adherenceRate">100%</div>
                    <div class="stat-label">Adherence Rate</div>
                </div>
            </div>

            <div class="card">
                <h3>Missed Doses History</h3>
                <div id="missedDosesContainer"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>


        // Language translations
        const translations = {
            en: {
                appTitle: "DigiHealth Card",
                appSubtitle: "Your Personal Medical Records",
                profileTab: "Profile",
                recordsTab: "Records", 
                medicationsTab: "Medications",
                remindersTab: "Reminders",
                profileTitle: "Personal Information",
                nameLabel: "Full Name",
                ageLabel: "Age",
                bloodGroupLabel: "Blood Group",
                phoneLabel: "Phone Number",
                emergencyContactLabel: "Emergency Contact",
                allergiesLabel: "Known Allergies",
                saveProfileBtn: "Save Profile",
                emergencyTitle: "Emergency Information",
                emergencyInfoText: "Complete your profile to display emergency information",
                qrTitle: "Share Medical Info",
                generateQRBtn: "Generate QR Code",
                addRecordTitle: "Add Medical Record",
                recordDateLabel: "Date",
                recordTypeLabel: "Type",
                doctorNameLabel: "Doctor/Hospital",
                recordNotesLabel: "Notes/Diagnosis",
                addRecordBtn: "Add Record",
                recordsListTitle: "Medical History",
                missedDosesTab:"Missed Doses"
            },
            hi: {
                appTitle: "डिजी हेल्थ कार्ड",
                appSubtitle: "आपके व्यक्तिगत चिकित्सा रिकॉर्ड",
                profileTab: "प्रोफाइल",
                recordsTab: "रिकॉर्ड",
                medicationsTab: "दवाएं",
                remindersTab: "रिमाइंडर",
                profileTitle: "व्यक्तिगत जानकारी",
                nameLabel: "पूरा नाम",
                ageLabel: "उम्र",
                bloodGroupLabel: "रक्त समूह",
                phoneLabel: "फोन नंबर",
                emergencyContactLabel: "आपातकालीन संपर्क",
                allergiesLabel: "ज्ञात एलर्जी",
                saveProfileBtn: "प्रोफाइल सेव करें",
                emergencyTitle: "आपातकालीन जानकारी",
                emergencyInfoText: "आपातकालीन जानकारी प्रदर्शित करने के लिए अपनी प्रोफाइल पूरी करें",
                qrTitle: "चिकित्सा जानकारी साझा करें",
                generateQRBtn: "QR कोड जेनरेट करें",
                missedDosesTab: "छूटी हुई खुराक"
            },
            te: {
                appTitle: "డిజి హెల్త్ కార్డ్",
                appSubtitle: "మీ వ్యక్తిగత వైద్య రికార్డులు",
                profileTab: "ప్రొఫైల్",
                recordsTab: "రికార్డులు",
                medicationsTab: "మందులు",
                remindersTab: "రిమైండర్లు",
                profileTitle: "వ్యక్తిగత సమాచారం",
                nameLabel: "పూర్తి పేరు",
                ageLabel: "వయస్సు",
                bloodGroupLabel: "బ్లడ్ గ్రూప్",
                phoneLabel: "ఫోన్ నంబర్",
                emergencyContactLabel: "అత్యవసర సంప్రదింపు",
                allergiesLabel: "తెలిసిన అలెర్జీలు",
                saveProfileBtn: "ప్రొఫైల్ సేవ్ చేయండి",
                emergencyTitle: "అత్యవసర సమాచారం",
                emergencyInfoText: "అత్యవసర సమాచారం ప్రదర్శించడానికి మీ ప్రొఫైల్ పూర్తి చేయండి",
                qrTitle: "వైద్య సమాచారం భాగస్వామ్యం",
                generateQRBtn: "QR కోడ్ జనరేట్ చేయండి",
                missedDosesTab:"తప్పిపోయిన మోతాదులు"
            },
               gu: {
                appTitle: "ડિજિ હેલ્થ કાર્ડ",
                appSubtitle: "તમારા વ્યક્તિગત તબીબી રેકોર્ડ્સ",
                profileTab: "પ્રોફાઇલ",
                recordsTab: "રેકોર્ડ્સ",
                medicationsTab: "દવાઓ",
                remindersTab: "રિમાઇન્ડર્સ",
                profileTitle: "વ્યક્તિગત માહિતી",
                nameLabel: "પૂરું નામ",
                ageLabel: "ઉંમર",
                bloodGroupLabel: "બ્લડ ગ્રુપ",
                phoneLabel: "ફોન નંબર",
                emergencyContactLabel: "કટોકટી સંપર્ક",
                allergiesLabel: "જાણીતી એલર્જી",
                saveProfileBtn: "પ્રોફાઇલ સેવ કરો",
                emergencyTitle: "કટોકટી માહિતી",
                emergencyInfoText: "કટોકટી માહિતી દર્શાવવા માટે તમારી પ્રોફાઇલ પૂર્ણ કરો",
                qrTitle: "તબીબી માહિતી શેર કરવી",
                generateQRBtn: "QR કોડ જનરેટ કરો",
                missedDosesTab: "ચૂકી ગયેલ ડોઝ"
            }
        };
                // Global variables
                let currentLanguage = 'en';
                let patientData = {};
                let medicalRecords = [];
                let medications = [];
                let reminders = [];
                let medicationReminders = [];
                let missedDoses = [];
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            displayRecords();
            displayMedications();
            displayReminders();
            displayMissedDoses();
            checkMedicationReminders();
            updateConnectionStatus();
            updateAllBadges();
            
            // Set current date as default
            document.getElementById('recordDate').valueAsDate = new Date();
            document.getElementById('startDate').valueAsDate = new Date();

            // Language selector change
            document.getElementById('languageSelector').addEventListener('change', function() {
                changeLanguage(this.value);
            });

            // Check for medication reminders every minute
            setInterval(checkMedicationReminders, 60000);
            setInterval(updateAllBadges, 30000);
        });

        // Language functions
        function changeLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];
            
            // Update all translatable elements
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.tagName === 'INPUT' && element.placeholder) {
                        // Handle placeholder text
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
        }

        // Data loading function
        function loadAllData() {
            patientData = JSON.parse(localStorage.getItem('patientData')) || {};
            medicalRecords = JSON.parse(localStorage.getItem('medicalRecords')) || [];
            medications = JSON.parse(localStorage.getItem('medications')) || [];
            reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            medicationReminders = JSON.parse(localStorage.getItem('medicationReminders')) || [];
            missedDoses = JSON.parse(localStorage.getItem('missedDoses')) || [];
            loadPatientData();
        }

        // Export/Import functionality
        function exportData() {
            const allData = {
                patientData,
                medicalRecords,
                medications,
                reminders,
                medicationReminders,
                missedDoses,
                exportDate: new Date().toISOString(),
                version: "1.0"
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `digihealth-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('✅ Data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('⚠️ This will overwrite all existing data. Are you sure you want to continue?')) {
                        // Import all data
                        patientData = importedData.patientData || {};
                        medicalRecords = importedData.medicalRecords || [];
                        medications = importedData.medications || [];
                        reminders = importedData.reminders || [];
                        medicationReminders = importedData.medicationReminders || [];
                        missedDoses = importedData.missedDoses || [];
                        
                        // Save to localStorage
                        localStorage.setItem('patientData', JSON.stringify(patientData));
                        localStorage.setItem('medicalRecords', JSON.stringify(medicalRecords));
                        localStorage.setItem('medications', JSON.stringify(medications));
                        localStorage.setItem('reminders', JSON.stringify(reminders));
                        localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
                        localStorage.setItem('missedDoses', JSON.stringify(missedDoses));
                        
                        // Refresh displays
                        loadPatientData();
                        displayRecords();
                        displayMedications();
                        displayReminders();
                        displayMissedDoses();
                        updateAllBadges();
                        
                        showNotification('✅ Data imported successfully!');
                    }
                } catch (error) {
                    showNotification('❌ Error importing data. Please check the file format.', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Profile functions
        function loadPatientData() {
            if (patientData.name) {
                document.getElementById('patientName').value = patientData.name || '';
                document.getElementById('patientAge').value = patientData.age || '';
                document.getElementById('bloodGroup').value = patientData.bloodGroup || '';
                document.getElementById('phoneNumber').value = patientData.phone || '';
                document.getElementById('emergencyContact').value = patientData.emergencyContact || '';
                document.getElementById('allergies').value = patientData.allergies || '';
                updateEmergencyInfo();
            }
        }

        function saveProfile() {
            patientData = {
                name: document.getElementById('patientName').value,
                age: document.getElementById('patientAge').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                phone: document.getElementById('phoneNumber').value,
                emergencyContact: document.getElementById('emergencyContact').value,
                allergies: document.getElementById('allergies').value,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('patientData', JSON.stringify(patientData));
            updateEmergencyInfo();
            showNotification('Profile saved successfully!');
        }

        function updateEmergencyInfo() {
            const emergencyInfo = document.getElementById('emergencyInfo');
            if (patientData.name) {
                emergencyInfo.innerHTML = `
                    <strong>${patientData.name}</strong><br>
                    Age: ${patientData.age} | Blood: ${patientData.bloodGroup}<br>
                    Emergency: ${patientData.emergencyContact}<br>
                    Allergies: ${patientData.allergies || 'None listed'}
                `;
            }
        }

        // Medical records functions
        function addRecord() {
            const record = {
                id: Date.now(),
                date: document.getElementById('recordDate').value,
                type: document.getElementById('recordType').value,
                doctor: document.getElementById('doctorName').value,
                notes: document.getElementById('recordNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!record.date || !record.doctor || !record.notes) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            medicalRecords.unshift(record);
            localStorage.setItem('medicalRecords', JSON.stringify(medicalRecords));
            displayRecords();
            
            // Clear form
            document.getElementById('recordDate').valueAsDate = new Date();
            document.getElementById('doctorName').value = '';
            document.getElementById('recordNotes').value = '';
            
            showNotification('Medical record added successfully!');
        }

        function displayRecords() {
            const container = document.getElementById('recordsContainer');
            if (medicalRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No medical records yet. Add your first record above.</p>';
                return;
            }

            container.innerHTML = medicalRecords.map(record => `
                <div class="record-item">
                    <button class="delete-btn" onclick="deleteRecord(${record.id})">×</button>
                    <h4>${record.type.charAt(0).toUpperCase() + record.type.slice(1)}</h4>
                    <p><strong>Date:</strong> ${new Date(record.date).toLocaleDateString()}</p>
                    <p><strong>Doctor/Hospital:</strong> ${record.doctor}</p>
                    <p><strong>Notes:</strong> ${record.notes}</p>
                </div>
            `).join('');
        }

        function deleteRecord(id) {
            medicalRecords = medicalRecords.filter(record => record.id !== id);
            localStorage.setItem('medicalRecords', JSON.stringify(medicalRecords));
            displayRecords();
            showNotification('Record deleted');
        }

        function toggleCustomFrequency() {
            const frequency = document.getElementById('frequency').value;
            const customGroup = document.getElementById('customFrequencyGroup');
            
            if (frequency === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }

        // Enhanced Medication functions with reminder system
        function addMedication() {
            const frequency = document.getElementById('frequency').value;
            let finalFrequency = frequency;
            
            if (frequency === 'custom') {
                const customDays = document.getElementById('customFrequencyDays').value;
                finalFrequency = `every-${customDays}-days`;
            }

            const medication = {
                id: Date.now(),
                name: document.getElementById('medicationName').value,
                dosage: document.getElementById('dosage').value,
                frequency: finalFrequency,
                timing: document.getElementById('timing').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                active: true,
                lastTaken: null,
                status: 'pending'
            };

            if (!medication.name || !medication.dosage || !medication.timing) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            medications.push(medication);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            // Create medication reminders
            createMedicationReminders(medication);
            
            displayMedications();
            
            // Clear form
            document.getElementById('medicationName').value = '';
            document.getElementById('dosage').value = '';
            document.getElementById('timing').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('frequency').value = 'daily';
            toggleCustomFrequency();
            
            showNotification('Medication added successfully!');
            updateAllBadges();
        }

        function createMedicationReminders(medication) {
            const today = new Date();
            const startDate = new Date(medication.startDate);
            const endDate = medication.endDate ? new Date(medication.endDate) : new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000); // Default 30 days

            // Generate reminders based on frequency
            const timeParts = medication.timing.split(':');
            const hour = parseInt(timeParts[0]);
            const minute = parseInt(timeParts[1]);

            // Handle custom frequency
            if (medication.frequency.startsWith('every-') && medication.frequency.endsWith('-days')) {
                const dayInterval = parseInt(medication.frequency.split('-')[1]);
                
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + dayInterval)) {
                    const reminderTime = new Date(date);
                    reminderTime.setHours(hour, minute, 0, 0);
                    
                    if (reminderTime >= today) {
                        medicationReminders.push({
                            id: `med_${medication.id}_${reminderTime.getTime()}`,
                            medicationId: medication.id,
                            medicationName: medication.name,
                            dosage: medication.dosage,
                            scheduledTime: reminderTime.toISOString(),
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            }
            // Handle weekly frequency
            else if (medication.frequency === 'weekly') {
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 7)) {
                    const reminderTime = new Date(date);
                    reminderTime.setHours(hour, minute, 0, 0);
                    
                    if (reminderTime >= today) {
                        medicationReminders.push({
                            id: `med_${medication.id}_${reminderTime.getTime()}`,
                            medicationId: medication.id,
                            medicationName: medication.name,
                            dosage: medication.dosage,
                            scheduledTime: reminderTime.toISOString(),
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            }
            // Handle daily frequency
            else if (medication.frequency === 'daily') {
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    const reminderTime = new Date(date);
                    reminderTime.setHours(hour, minute, 0, 0);
                    
                    if (reminderTime >= today) {
                        medicationReminders.push({
                            id: `med_${medication.id}_${reminderTime.getTime()}`,
                            medicationId: medication.id,
                            medicationName: medication.name,
                            dosage: medication.dosage,
                            scheduledTime: reminderTime.toISOString(),
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            }
            // Handle twice daily frequency
            else if (medication.frequency === 'twice-daily') {
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    // Morning and evening doses
                    const morningTime = new Date(date);
                    morningTime.setHours(hour, minute, 0, 0);
                    const eveningTime = new Date(date);
                    eveningTime.setHours((hour + 12) % 24, minute, 0, 0);

                    if (morningTime >= today) {
                        medicationReminders.push({
                            id: `med_${medication.id}_${morningTime.getTime()}`,
                            medicationId: medication.id,
                            medicationName: medication.name,
                            dosage: medication.dosage,
                            scheduledTime: morningTime.toISOString(),
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                    }
                    if (eveningTime >= today) {
                        medicationReminders.push({
                            id: `med_${medication.id}_${eveningTime.getTime()}`,
                            medicationId: medication.id,
                            medicationName: medication.name,
                            dosage: medication.dosage,
                            scheduledTime: eveningTime.toISOString(),
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            }
            // Handle thrice daily frequency
            else if (medication.frequency === 'thrice-daily') {
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    // Morning, afternoon, and evening doses
                    const times = [hour, hour + 6, hour + 12];
                    times.forEach(h => {
                        const reminderTime = new Date(date);
                        reminderTime.setHours(h % 24, minute, 0, 0);
                        
                        if (reminderTime >= today) {
                            medicationReminders.push({
                                id: `med_${medication.id}_${reminderTime.getTime()}`,
                                medicationId: medication.id,
                                medicationName: medication.name,
                                dosage: medication.dosage,
                                scheduledTime: reminderTime.toISOString(),
                                status: 'pending',
                                createdAt: new Date().toISOString()
                            });
                        }
                    });
                }
            }

            localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
        }

        function displayMedications() {
            const container = document.getElementById('medicationsContainer');
            const activeMedications = medications.filter(med => med.active);
            
            if (activeMedications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No active medications. Add your medications above.</p>';
                return;
            }

            container.innerHTML = activeMedications.map(medication => {
                const nextReminder = getNextMedicationReminder(medication.id);
                let nextDoseText = '';
                let statusClass = '';
                
                // Format frequency display
                let frequencyDisplay = medication.frequency;
                if (medication.frequency.startsWith('every-') && medication.frequency.endsWith('-days')) {
                    const days = medication.frequency.split('-')[1];
                    frequencyDisplay = `Every ${days} Days`;
                }

                if (nextReminder) {
                    const nextTime = new Date(nextReminder.scheduledTime);
                    const now = new Date();
                    const timeDiff = nextTime - now;

                    if (timeDiff < 0) {
                        nextDoseText = `<div class="next-dose overdue">⚠️ Overdue by ${Math.floor(Math.abs(timeDiff) / (1000 * 60))} minutes</div>`;
                        statusClass = 'overdue';
                    } else if (timeDiff < 3600000) { // Less than 1 hour
                        nextDoseText = `<div class="next-dose">⏰ Next dose in ${Math.floor(timeDiff / (1000 * 60))} minutes</div>`;
                    } else {
                        nextDoseText = `<div class="next-dose">📅 Next dose: ${nextTime.toLocaleString()}</div>`;
                    }
                }

                return `
                    <div class="medication-item ${statusClass}">
                        <button class="delete-btn" onclick="deleteMedication(${medication.id})">×</button>
                        <h4>${medication.name}</h4>
                        <p><strong>Dosage:</strong> ${medication.dosage}</p>
                        <p><strong>Frequency:</strong> ${frequencyDisplay}</p>
                        <p><strong>Time:</strong> ${medication.timing}</p>
                        <p><strong>Duration:</strong> ${new Date(medication.startDate).toLocaleDateString()} ${medication.endDate ? '- ' + new Date(medication.endDate).toLocaleDateString() : '(Ongoing)'}</p>
                        ${nextDoseText}
                        <div class="medication-actions">
                            <button class="btn btn-success btn-small" onclick="markMedicationTaken(${medication.id})">✅ Taken</button>
                            <button class="btn btn-warning btn-small" onclick="snoozeMedication(${medication.id})">⏰ Snooze 15min</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getNextMedicationReminder(medicationId) {
            const now = new Date();
            return medicationReminders
                .filter(reminder => reminder.medicationId === medicationId && reminder.status === 'pending')
                .sort((a, b) => new Date(a.scheduledTime) - new Date(b.scheduledTime))[0];
        }

        function markMedicationTaken(medicationId) {
            const now = new Date();
            const activeReminder = medicationReminders.find(reminder => 
                reminder.medicationId === medicationId && 
                reminder.status === 'pending' &&
                Math.abs(new Date(reminder.scheduledTime) - now) < 2 * 60 * 60 * 1000 // Within 2 hours
            );

            if (activeReminder) {
                activeReminder.status = 'taken';
                activeReminder.takenAt = now.toISOString();
                
                // Update medication last taken
                const medication = medications.find(med => med.id === medicationId);
                if (medication) {
                    medication.lastTaken = now.toISOString();
                }

                localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
                localStorage.setItem('medications', JSON.stringify(medications));
                
                displayMedications();
                showNotification('✅ Medication marked as taken!', 'medication');
                updateAllBadges();
            } else {
                showNotification('No pending dose found for this medication', 'error');
            }
        }

        function snoozeMedication(medicationId) {
            const now = new Date();
            const activeReminder = medicationReminders.find(reminder => 
                reminder.medicationId === medicationId && 
                reminder.status === 'pending' &&
                Math.abs(new Date(reminder.scheduledTime) - now) < 2 * 60 * 60 * 1000
            );

            if (activeReminder) {
                // Create a snoozed reminder 15 minutes from now
                const snoozeTime = new Date(now.getTime() + 15 * 60 * 1000);
                
                const snoozedReminder = {
                    ...activeReminder,
                    id: `${activeReminder.id}_snooze_${Date.now()}`,
                    scheduledTime: snoozeTime.toISOString(),
                    status: 'pending',
                    originalTime: activeReminder.scheduledTime,
                    snoozed: true
                };

                activeReminder.status = 'snoozed';
                medicationReminders.push(snoozedReminder);
                
                localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
                displayMedications();
                showNotification('⏰ Medication snoozed for 15 minutes', 'medication');
            } else {
                showNotification('No pending dose found for this medication', 'error');
            }
        }

        function deleteMedication(id) {
            medications = medications.filter(med => med.id !== id);
            medicationReminders = medicationReminders.filter(reminder => reminder.medicationId !== id);
            
            localStorage.setItem('medications', JSON.stringify(medications));
            localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
            
            displayMedications();
            showNotification('Medication removed');
            updateAllBadges();
        }

        // Medication reminder checking system
        function checkMedicationReminders() {
            const now = new Date();
            
            // Check for missed medications (30 minutes past due)
            medicationReminders.forEach(reminder => {
                if (reminder.status === 'pending') {
                    const scheduledTime = new Date(reminder.scheduledTime);
                    const timeDiff = now - scheduledTime;
                    
                    // Mark as missed if 30 minutes overdue
                    if (timeDiff > .10 * 60 * 1000) {
                        reminder.status = 'missed';
                        reminder.missedAt = now.toISOString();
                        
                        // Add to missed doses
                        const missedDose = {
                            id: `missed_${Date.now()}`,
                            medicationId: reminder.medicationId,
                            medicationName: reminder.medicationName,
                            dosage: reminder.dosage,
                            scheduledTime: reminder.scheduledTime,
                            missedAt: now.toISOString(),
                            reason: 'Not taken within 30 minutes'
                        };
                        
                        missedDoses.push(missedDose);
                        localStorage.setItem('missedDoses', JSON.stringify(missedDoses));
                        
                        showNotification(`❌ Missed dose: ${reminder.medicationName}`, 'error');
                    }
                    // Show reminder notifications
                    else if (timeDiff >= -5 * 60 * 1000 && timeDiff <= 5 * 60 * 1000) {
                        // Within 5 minutes of scheduled time
                        showMedicationNotification(reminder);
                    }
                }
            });

            localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
            displayMedications();
            displayMissedDoses();
            updateAllBadges();
        }

        function showMedicationNotification(reminder) {
            const now = new Date();
            const scheduledTime = new Date(reminder.scheduledTime);
            const isOverdue = now > scheduledTime;
            
            let message;
            if (isOverdue) {
                const minutesLate = Math.floor((now - scheduledTime) / (1000 * 60));
                message = `💊 ${reminder.medicationName} - ${minutesLate} minutes overdue!`;
            } else {
                message = `💊 Time for ${reminder.medicationName} - ${reminder.dosage}`;
            }
            
            showNotification(message, 'medication');
            
            // Try to use browser notification API if available
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Medication Reminder', {
                    body: message,
                    icon: '💊',
                    tag: reminder.id
                });
            }
        }

        // Missed Doses functions
        function displayMissedDoses() {
            const container = document.getElementById('missedDosesContainer');
            
            if (missedDoses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No missed doses recorded. Great job staying on track! 🎉</p>';
            } else {
                const sortedMissedDoses = missedDoses.sort((a, b) => new Date(b.missedAt) - new Date(a.missedAt));
                
                container.innerHTML = sortedMissedDoses.map(missed => `
                    <div class="missed-dose-item">
                        <button class="delete-btn" onclick="deleteMissedDose('${missed.id}')">×</button>
                        <h4>❌ ${missed.medicationName}</h4>
                        <p><strong>Dosage:</strong> ${missed.dosage}</p>
                        <p><strong>Scheduled:</strong> ${new Date(missed.scheduledTime).toLocaleString()}</p>
                        <p><strong>Missed:</strong> ${new Date(missed.missedAt).toLocaleString()}</p>
                        <p><strong>Reason:</strong> ${missed.reason}</p>
                        <div class="medication-actions">
                            <button class="btn btn-success btn-small" onclick="markMissedAsTaken('${missed.id}')">Mark as Taken Late</button>
                        </div>
                    </div>
                `).join('');
            }
            
            updateMissedDoseStats();
        }

        function updateMissedDoseStats() {
            const totalMissed = missedDoses.length;
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const thisWeekMissed = missedDoses.filter(missed => new Date(missed.missedAt) > oneWeekAgo).length;
            
            // Calculate adherence rate
            const totalScheduled = medicationReminders.filter(r => r.status !== 'pending').length;
            const totalTaken = medicationReminders.filter(r => r.status === 'taken').length;
            const adherenceRate = totalScheduled > 0 ? Math.round((totalTaken / totalScheduled) * 100) : 100;
            
            document.getElementById('totalMissedCount').textContent = totalMissed;
            document.getElementById('thisWeekMissedCount').textContent = thisWeekMissed;
            document.getElementById('adherenceRate').textContent = adherenceRate + '%';
        }

        function deleteMissedDose(id) {
            missedDoses = missedDoses.filter(missed => missed.id !== id);
            localStorage.setItem('missedDoses', JSON.stringify(missedDoses));
            displayMissedDoses();
            showNotification('Missed dose record deleted');
            updateAllBadges();
        }

        function markMissedAsTaken(missedId) {
            const missedDose = missedDoses.find(missed => missed.id === missedId);
            if (missedDose) {
                // Find the corresponding reminder and mark as taken
                const reminder = medicationReminders.find(r => 
                    r.medicationId === missedDose.medicationId && 
                    r.scheduledTime === missedDose.scheduledTime
                );
                
                if (reminder) {
                    reminder.status = 'taken';
                    reminder.takenAt = new Date().toISOString();
                    reminder.takenLate = true;
                }
                
                // Remove from missed doses
                missedDoses = missedDoses.filter(missed => missed.id !== missedId);
                
                localStorage.setItem('medicationReminders', JSON.stringify(medicationReminders));
                localStorage.setItem('missedDoses', JSON.stringify(missedDoses));
                
                displayMissedDoses();
                showNotification('✅ Marked as taken late', 'medication');
                updateAllBadges();
            }
        }

        // Reminder functions
        function addReminder() {
            const reminder = {
                id: Date.now(),
                type: document.getElementById('reminderType').value,
                title: document.getElementById('reminderTitle').value,
                datetime: document.getElementById('reminderDateTime').value,
                notes: document.getElementById('reminderNotes').value,
                completed: false
            };

            if (!reminder.title || !reminder.datetime) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            reminders.push(reminder);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            displayReminders();
            
            // Clear form
            document.getElementById('reminderTitle').value = '';
            document.getElementById('reminderDateTime').value = '';
            document.getElementById('reminderNotes').value = '';
            
            showNotification('Reminder added successfully!');
            updateAllBadges();
        }

        function displayReminders() {
            const container = document.getElementById('remindersContainer');
            const activeReminders = reminders.filter(rem => !rem.completed).sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            if (activeReminders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No upcoming reminders. Add a reminder above.</p>';
                return;
            }

            container.innerHTML = activeReminders.map(reminder => {
                const reminderDate = new Date(reminder.datetime);
                const now = new Date();
                const isOverdue = reminderDate < now;
                const timeUntil = Math.abs(reminderDate - now);
                const daysUntil = Math.floor(timeUntil / (1000 * 60 * 60 * 24));
                const hoursUntil = Math.floor((timeUntil % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                let timeText = '';
                if (isOverdue) {
                    timeText = `<span style="color: #f44336;">Overdue by ${daysUntil} days</span>`;
                } else if (daysUntil === 0) {
                    timeText = `<span style="color: #ff9800;">Today in ${hoursUntil} hours</span>`;
                } else {
                    timeText = `In ${daysUntil} days`;
                }

                return `
                    <div class="reminder-item" style="${isOverdue ? 'border-left-color: #f44336;' : ''}">
                        <button class="delete-btn" onclick="deleteReminder(${reminder.id})">×</button>
                        <h4>${reminder.title}</h4>
                        <p><strong>Type:</strong> ${reminder.type.charAt(0).toUpperCase() + reminder.type.slice(1)}</p>
                        <p><strong>Date & Time:</strong> ${reminderDate.toLocaleDateString()} at ${reminderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        <p><strong>Status:</strong> ${timeText}</p>
                        ${reminder.notes ? `<p><strong>Notes:</strong> ${reminder.notes}</p>` : ''}
                        <button class="btn btn-small" onclick="markReminderComplete(${reminder.id})" style="margin-top: 10px;">Mark Complete</button>
                    </div>
                `;
            }).join('');
        }

        function deleteReminder(id) {
            reminders = reminders.filter(rem => rem.id !== id);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            displayReminders();
            showNotification('Reminder deleted');
            updateAllBadges();
        }

        function markReminderComplete(id) {
            const reminder = reminders.find(rem => rem.id === id);
            if (reminder) {
                reminder.completed = true;
                localStorage.setItem('reminders', JSON.stringify(reminders));
                displayReminders();
                showNotification('Reminder marked as complete!');
                updateAllBadges();
            }
        }

        // Badge update functions
        function updateAllBadges() {
            updateMedicationBadges();
            updateReminderBadges();
            updateMissedDosesBadges();
        }

        function updateMedicationBadges() {
            const activeMeds = medications.filter(med => med.active).length;
            const badge = document.getElementById('medicationBadge');
            if (activeMeds > 0) {
                badge.textContent = activeMeds;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateReminderBadges() {
            const activeReminders = reminders.filter(rem => !rem.completed).length;
            const badge = document.getElementById('reminderBadge');
            if (activeReminders > 0) {
                badge.textContent = activeReminders;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateMissedDosesBadges() {
            const badge = document.getElementById('missedDosesBadge');
            if (missedDoses.length > 0) {
                badge.textContent = missedDoses.length;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // QR Code generation
        function generateQR() {
            if (!patientData.name) {
                showNotification('Please save your profile first!', 'error');
                return;
            }

            const qrData = {
                name: patientData.name,
                age: patientData.age,
                bloodGroup: patientData.bloodGroup,
                phone: patientData.phone,
                emergencyContact: patientData.emergencyContact,
                allergies: patientData.allergies,
                lastUpdated: new Date().toISOString()
            };

            const canvas = document.createElement('canvas');
            const qr = new QRious({
                element: canvas,
                value: JSON.stringify(qrData),
                size: 200,
                background: 'white',
                foreground: 'black',
                level: 'M'
            });

            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '';
            qrContainer.appendChild(canvas);
            
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Download QR Code';
            downloadBtn.className = 'btn';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.fontSize = '14px';
            downloadBtn.onclick = function() {
                const link = document.createElement('a');
                link.download = `${patientData.name}-medical-qr.png`;
                link.href = canvas.toDataURL();
                link.click();
            };
            qrContainer.appendChild(downloadBtn);
            
            showNotification('QR Code generated! Medical professionals can scan this for your emergency info.');
        }

        // Connection status
        function updateConnectionStatus() {
            const isOnline = navigator.onLine;
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                indicator.className = 'status-indicator status-online';
                statusText.textContent = 'Online Mode';
            } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Offline Mode';
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Listen for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
    </script>
</body>
</html>
